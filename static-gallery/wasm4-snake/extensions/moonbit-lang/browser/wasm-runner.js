"use strict";var R=Symbol("Comlink.proxy"),V=Symbol("Comlink.endpoint"),j=Symbol("Comlink.releaseProxy"),P=Symbol("Comlink.finalizer"),E=Symbol("Comlink.thrown"),h=e=>typeof e=="object"&&e!==null||typeof e=="function",U={canHandle:e=>h(e)&&e[R],serialize(e){let{port1:r,port2:n}=new MessageChannel;return A(e,r),[n,[n]]},deserialize(e){return e.start(),v(e)}},N={canHandle:e=>h(e)&&E in e,serialize({value:e}){let r;return e instanceof Error?r={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:r={isError:!1,value:e},[r,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},L=new Map([["proxy",U],["throw",N]]);function H(e,r){for(let n of e)if(r===n||n==="*"||n instanceof RegExp&&n.test(r))return!0;return!1}function A(e,r=globalThis,n=["*"]){r.addEventListener("message",function a(s){if(!s||!s.data)return;if(!H(n,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}let{id:i,type:o,path:u}={path:[],...s.data},p=(s.data.argumentList||[]).map(f),c;try{let l=u.slice(0,-1).reduce((t,d)=>t[d],e),g=u.reduce((t,d)=>t[d],e);switch(o){case"GET":c=g;break;case"SET":l[u.slice(-1)[0]]=f(s.data.value),c=!0;break;case"APPLY":c=g.apply(l,p);break;case"CONSTRUCT":{let t=new g(...p);c=Y(t)}break;case"ENDPOINT":{let{port1:t,port2:d}=new MessageChannel;A(e,d),c=G(t,[t])}break;case"RELEASE":c=void 0;break;default:return}}catch(l){c={value:l,[E]:0}}Promise.resolve(c).catch(l=>({value:l,[E]:0})).then(l=>{let[g,t]=w(l);r.postMessage({...g,id:i},t),o==="RELEASE"&&(r.removeEventListener("message",a),O(r),P in e&&typeof e[P]=="function"&&e[P]())}).catch(l=>{let[g,t]=w({value:new TypeError("Unserializable return value"),[E]:0});r.postMessage({...g,id:i},t)})}),r.start&&r.start()}function z(e){return e.constructor.name==="MessagePort"}function O(e){z(e)&&e.close()}function v(e,r){return M(e,[],r)}function T(e){if(e)throw new Error("Proxy has been released and is not useable")}function S(e){return m(e,{type:"RELEASE"}).then(()=>{O(e)})}var x=new WeakMap,b="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{let r=(x.get(e)||0)-1;x.set(e,r),r===0&&S(e)});function D(e,r){let n=(x.get(r)||0)+1;x.set(r,n),b&&b.register(e,r,e)}function _(e){b&&b.unregister(e)}function M(e,r=[],n=function(){}){let a=!1,s=new Proxy(n,{get(i,o){if(T(a),o===j)return()=>{_(s),S(e),a=!0};if(o==="then"){if(r.length===0)return{then:()=>s};let u=m(e,{type:"GET",path:r.map(p=>p.toString())}).then(f);return u.then.bind(u)}return M(e,[...r,o])},set(i,o,u){T(a);let[p,c]=w(u);return m(e,{type:"SET",path:[...r,o].map(l=>l.toString()),value:p},c).then(f)},apply(i,o,u){T(a);let p=r[r.length-1];if(p===V)return m(e,{type:"ENDPOINT"}).then(f);if(p==="bind")return M(e,r.slice(0,-1));let[c,l]=k(u);return m(e,{type:"APPLY",path:r.map(g=>g.toString()),argumentList:c},l).then(f)},construct(i,o){T(a);let[u,p]=k(o);return m(e,{type:"CONSTRUCT",path:r.map(c=>c.toString()),argumentList:u},p).then(f)}});return D(s,e),s}function F(e){return Array.prototype.concat.apply([],e)}function k(e){let r=e.map(w);return[r.map(n=>n[0]),F(r.map(n=>n[1]))]}var W=new WeakMap;function G(e,r){return W.set(e,r),e}function Y(e){return Object.assign(e,{[R]:!0})}function w(e){for(let[r,n]of L)if(n.canHandle(e)){let[a,s]=n.serialize(e);return[{type:"HANDLER",name:r,value:a},s]}return[{type:"RAW",value:e},W.get(e)||[]]}function f(e){switch(e.type){case"HANDLER":return L.get(e.name).deserialize(e.value);case"RAW":return e.value}}function m(e,r,n){return new Promise(a=>{let s=J();e.addEventListener("message",function i(o){!o.data||!o.data.id||o.data.id!==s||(e.removeEventListener("message",i),a(o.data))}),e.start&&e.start(),e.postMessage({id:s,...r},n)})}function J(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var y=e=>{self.postMessage(e)},$=[["spectest","print_char"],["js_string","new"],["js_string","log"],["js_string","append"],["js_string","empty"]],q=()=>new Promise((e,r)=>{let n=a=>{self.removeEventListener("message",n);let s=a.ports[0];if(s===void 0)r(new Error("not port"));else{let i=v(s);e(i)}};self.addEventListener("message",n)}),C=()=>new Promise(e=>{let r=n=>{self.removeEventListener("message",r),e(n.data)};self.addEventListener("message",r)});async function B(){let e=await q(),r=await C();await e.fire("\x1B[2J\x1B[3J\x1B[;H");try{let n=r.wasm,a=URL.createObjectURL(new Blob([r.runtimeCode],{type:"application/javascript"})),s=await import(a);URL.revokeObjectURL(a);let i=s.default;for(let[t,d]of $)t in i&&d in i[t]&&await e.fire(`\x1B[1;33mWarning\x1B[0m: \x1B[1m${t}.${d}\x1B[0m is a reserved runtime, override it may break moonbit\r
`);let o=[],u=()=>{if(o.length===0)return;let t=new TextDecoder("utf-16").decode(new Uint16Array(o));e.fire(t.replace(`
`,`\r
`)),o.length=0},p,c={spectest:{print_char:t=>{o.push(t),t===10&&u()}},js_string:{new:(t,d)=>{let I=new Uint8Array(p.buffer,t,d);return new TextDecoder().decode(I)},log:t=>{e.fire(t.replace(`
`,`\r
`)+`\r
`)},append:(t,d)=>t+d,empty:()=>"",...i?.js_string},...(delete i?.js_string,i)};y({kind:"start",stamp:performance.now()});let{instance:l}=await WebAssembly.instantiate(n,c);p=l.exports["moonbit.memory"];let g=l.exports._start;if(g===void 0){y({kind:"over",stamp:performance.now()});return}y({kind:"load"}),await C(),g(),y({kind:"over",stamp:performance.now()}),u()}catch(n){n instanceof WebAssembly.CompileError?y({kind:"internal",message:n.message}):n instanceof Error&&await e.fire(n.message)}}B();
/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
